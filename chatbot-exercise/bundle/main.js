var t,e;import{createInterface as s}from"readline/promises";import{zodResponseFormat as a}from"openai/helpers/zod";import{z as n}from"zod";import i from"openai";(e=t||(t={})).System="system",e.User="user",e.Assistant="assistant";class o{outStream;model;openAI;PatientDataResponse=n.object({assistant_response:n.string(),is_patient_give_info:n.boolean(),patient_name:n.string(),patient_age:n.number()});constructor(t,e,s="gpt-4o-mini"){this.outStream=t,this.model=s,this.openAI=new i({apiKey:e})}async getPatientData(e){let s={model:this.model,messages:this.convertMessagesToParams(e),response_format:a(this.PatientDataResponse,"data")},n=await this.openAI.beta.chat.completions.parse(s),i=n.choices[0]?.message;if(i?.parsed){let e;return i.parsed.is_patient_give_info&&(e={name:i.parsed.patient_name,age:i.parsed.patient_age}),[{actor:t.Assistant,content:i.parsed.assistant_response},e]}return i?.content?[{actor:t.Assistant,content:i.content},void 0]:[void 0,void 0]}async respondToQueryStream(e){let s={model:this.model,messages:this.convertMessagesToParams(e)},a=await this.openAI.beta.chat.completions.stream(s);for await(let t of a)this.outStream.write(t.choices[0]?.delta?.content??"");let n=await a.finalContent();return n?{actor:t.Assistant,content:n}:void 0}convertMessagesToParams(t){return t.map(t=>({role:t.actor,content:[{type:"text",text:t.content}]}))}}class r{client;messages=[];patientData;constructor(){let t=process.env.OPENAI_API_KEY;if(!t)throw Error(`Please set OPENAI_API_KEY environment variable.
export OPENAI_API_KEY="your_api_key_here"`);this.client=new o(process.stdout,t)}async run(){this.init(),await this.getPatientAgeStep(),this.patientData&&(await this.questionAnswersStep(),console.log("\n\nThis is all the questions I can answer at this time. Thank you.\n"))}async getPatientAgeStep(){let e="Hello, I'm here for you at this hard time. May I have your name and age to assist you better please?";console.log(`${e}
`),this.messages.push({actor:t.Assistant,content:e});let s=3;for(;!this.patientData&&s-- >0;){await this.getInputFromUser();let[t,e]=await this.client.getPatientData(this.messages);t&&(this.messages.push(t),console.log(`
${t.content}
`)),e&&this.setPatientData(e)}}async questionAnswersStep(){for(let t=0;t<3;t++){await this.getInputFromUser();let t=await this.client.respondToQueryStream(this.messages);t&&this.messages.push(t)}}async getInputFromUser(){let e=s({input:process.stdin,output:process.stdout});try{let s;for(;!s;)s=(await e.question("> ")).trim();this.messages.push({actor:t.User,content:s}),console.log()}finally{e.close()}}setPatientData(e){this.patientData=e;let s=`Patient is ${e.age} years old.`;e.name&&(s+=` Patient's name is ${e.name}.`),this.messages.push({actor:t.System,content:s})}init(){this.patientData=void 0,this.messages=[{actor:t.System,content:`You are a healthcare assistant. 
          You art providing information to a breast cancer patient.
          You need to know the patient's name and age to assist them better.
          You can work with only the age if the patient prefers to remain anonymous.
          You absolutely must have the age and will not answer any questions without know it.`},{actor:t.System,content:`You know the following on breast cancer and use only this information to respond to patient questions: 
        In 2022, there were 2.3 million women diagnosed with breast cancer and 670000 deaths globally. Breast cancer occurs 
        in every country of the world in women at any age after puberty but with increasing rates in later life. Global 
        estimates reveal striking inequities in the breast cancer burden according to human development. For instance, 
        in countries with a very high Human Development Index (HDI), 1 in 12 women will be diagnosed with breast cancer 
        in their lifetime and 1 in 71 women die of it. In contrast, in countries with a low HDI; while only 1 in 27 women 
        is diagnosed with breast cancer in their lifetime, 1 in 48 women will die from it.`}]}}async function c(){let t=new r;console.log("\n---\n"),await t.run(),console.log("\n\n---\n")}await c();
//# sourceMappingURL=main.js.map
